<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenLayers with D3 for Lines, Polygons, and Multipolygons</title>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script src="https://cdn.jsdelivr.net/npm/ol@v10.3.1/dist/ol.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v10.3.1/ol.css">
    <style>
        html,
        body,
        #map {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
        }

        .custom-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            /* Prevent interference with map interactions */
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <canvas id="d3-canvas" class="custom-canvas"></canvas>
    <script>
        // 1. Initialize the OpenLayers Map
        const map = new ol.Map({
            target: 'map',
            view: new ol.View({
                center: ol.proj.fromLonLat([36.8219, -1.2921]), // Nairobi, Kenya
                zoom: 6,
            }),
            layers: [
                new ol.layer.Tile({
                    source: new ol.source.OSM(), // OpenStreetMap Basemap
                }),
            ],
        });

        // 2. Setup the D3 Canvas
        const d3Canvas = document.getElementById('d3-canvas');
        const d3Context = d3Canvas.getContext('2d');

        const resizeCanvas = () => {
            const size = map.getSize();
            d3Canvas.width = size[0];
            d3Canvas.height = size[1];
        };
        map.on('resize', resizeCanvas);
        resizeCanvas();

        // 3. Sample Data
        const data = {
            points: [
                { lon: 36.8219, lat: -1.2921, magnitude: 5.1 }, // Nairobi
            ],
            lines: [
                {
                    type: 'LineString',
                    coordinates: [
                        [36.8219, -1.2921], // Nairobi
                        [37.075, -0.5143],  // Meru
                        [35.282, 0.515],    // Eldoret
                    ],
                },
            ],
            polygons: [
                {
                    type: 'Polygon',
                    coordinates: [
                        [
                            [36.8, -1.3],
                            [36.9, -1.3],
                            [36.9, -1.2],
                            [36.8, -1.2],
                            [36.8, -1.3],
                        ],
                    ],
                },
            ],
            multipolygons: [
                {
                    type: 'MultiPolygon',
                    coordinates: [
                        [
                            [
                                [36.7, -1.4],
                                [36.8, -1.4],
                                [36.8, -1.3],
                                [36.7, -1.3],
                                [36.7, -1.4],
                            ],
                        ],
                        [
                            [
                                [36.9, -1.5],
                                [37.0, -1.5],
                                [37.0, -1.4],
                                [36.9, -1.4],
                                [36.9, -1.5],
                            ],
                        ],
                    ],
                },
            ],
        };

        // 4. Render Features on Canvas
        const renderD3 = () => {
            d3Context.clearRect(0, 0, d3Canvas.width, d3Canvas.height);

            const extent = map.getView().calculateExtent();
            const projection = map.getView().getProjection();

            // Render Points
            data.points.forEach((d) => {
                const coordinate = ol.proj.transform([d.lon, d.lat], 'EPSG:4326', projection);
                if (ol.extent.containsCoordinate(extent, coordinate)) {
                    const pixel = map.getPixelFromCoordinate(coordinate);
                    if (pixel) {
                        d3Context.beginPath();
                        d3Context.arc(pixel[0], pixel[1], d.magnitude * 2, 0, 2 * Math.PI);
                        d3Context.fillStyle = 'rgba(255, 0, 0, 0.5)';
                        d3Context.fill();
                        d3Context.strokeStyle = 'red';
                        d3Context.stroke();
                    }
                }
            });

            // Render Lines
            data.lines.forEach((line) => {
                d3Context.beginPath();
                line.coordinates.forEach((coord, index) => {
                    const coordinate = ol.proj.transform(coord, 'EPSG:4326', projection);

                    // Check if the coordinate is within the visible map extent
                    if (ol.extent.containsCoordinate(extent, coordinate)) {
                        const pixel = map.getPixelFromCoordinate(coordinate);

                        // Ensure the pixel is valid
                        if (pixel) {
                            if (index === 0) {
                                d3Context.moveTo(pixel[0], pixel[1]);
                            } else {
                                d3Context.lineTo(pixel[0], pixel[1]);
                            }
                        } else {
                            //console.warn('Pixel is null for coordinate:', coord);
                        }
                    } else {
                        //console.warn('Coordinate outside extent:', coord);
                    }
                });

                // Set styles and draw the line
                d3Context.strokeStyle = 'blue';
                d3Context.lineWidth = 2;
                d3Context.stroke();
            });





            // Render Polygons
            data.polygons.forEach((polygon) => {
                d3Context.beginPath();
                polygon.coordinates[0].forEach((coord, index) => {
                    const coordinate = ol.proj.transform(coord, 'EPSG:4326', projection);

                    // Ensure the coordinate is within the map extent
                    if (ol.extent.containsCoordinate(extent, coordinate)) {
                        const pixel = map.getPixelFromCoordinate(coordinate);

                        // Check if pixel is valid
                        if (pixel) {
                            if (index === 0) {
                                d3Context.moveTo(pixel[0], pixel[1]);
                            } else {
                                d3Context.lineTo(pixel[0], pixel[1]);
                            }
                        }
                    } else {
                        //console.warn('Coordinate outside extent:', coord);
                    }
                });
                d3Context.closePath();
                d3Context.fillStyle = 'rgba(0, 255, 0, 0.5)';
                d3Context.fill();
                d3Context.strokeStyle = 'green';
                d3Context.stroke();
            });

            // Render Multipolygons
            data.multipolygons.forEach((multipolygon) => {
                multipolygon.coordinates.forEach((polygon) => {
                    d3Context.beginPath();
                    polygon[0].forEach((coord, index) => {
                        const coordinate = ol.proj.transform(coord, 'EPSG:4326', projection);

                        // Ensure the coordinate is within the map extent
                        if (ol.extent.containsCoordinate(extent, coordinate)) {
                            const pixel = map.getPixelFromCoordinate(coordinate);

                            // Check if pixel is valid
                            if (pixel) {
                                if (index === 0) {
                                    d3Context.moveTo(pixel[0], pixel[1]);
                                } else {
                                    d3Context.lineTo(pixel[0], pixel[1]);
                                }
                            }
                        } else {
                            //console.warn('Coordinate outside extent:', coord);
                        }
                    });
                    d3Context.closePath();
                    d3Context.fillStyle = 'rgba(0, 0, 255, 0.5)';
                    d3Context.fill();
                    d3Context.strokeStyle = 'blue';
                    d3Context.stroke();
                });
            });


        };

        // 5. Sync Canvas with Map Viewport
        map.on('postrender', () => {
            const rect = map.getViewport().getBoundingClientRect();
            d3Canvas.style.position = 'absolute';
            d3Canvas.style.top = `${rect.top}px`;
            d3Canvas.style.left = `${rect.left}px`;
            d3Canvas.width = map.getSize()[0];
            d3Canvas.height = map.getSize()[1];
        });

        // 6. Animate and Redraw Features
        renderD3(); // Initial render
        map.on('postrender', renderD3); // Redraw after render
        map.on('moveend', renderD3);   // Redraw after movement
    </script>
</body>

</html>